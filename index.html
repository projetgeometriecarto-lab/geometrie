<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Suivi Retouches Géométrie</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f3f3f3;
      margin: 0;
      padding: 0;
    }
    .header {
      background-color: #002c52;
      color: white;
      padding: 10px 20px;
      text-align: center;
      font-size: 1.5rem;
      position: relative;
    }
    /* Logo blanc en haut à gauche */
    .logo {
      position: absolute;
      top: 5px;
      left: 20px;
      height: 40px;
      filter: brightness(0) invert(1); /* rend logo blanc */
    }
    .tabs {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin: 10px 20px;
    }
    .tabs button {
      padding: 10px 20px;
      border: none;
      background-color: #eee;
      cursor: pointer;
    }
    .tabs button.active {
      background-color: #fff;
      border-bottom: 2px solid #002c52;
      font-weight: bold;
    }
    .tab-content {
      display: none;
      padding: 20px;
    }
    .tab-content.active {
      display: block;
    }
    /* Layout véhicule */
    .vehicle-map-container {
      position: relative;
      width: 1800px;
      height: 900px;
      margin: 0 auto;
      border: 1px solid #ccc;
      background-color: #fff;
    }
    /* Images des zones (en arrière-plan) */
    .vehicle-map-container img.zone {
      position: absolute;
      user-select: none;
      pointer-events: none; /* pour que les clics passent aux divs */
    }
    .face-avant { top: 300px; left: 590px; width: 550px !important; }
    .aile-gauche { top: 280px; left: 1100px; width: 250px !important;}
    .aile-droite { top: 280px; left: 400px; width: 250px !important;}
    .cote-gauche { top: 0px; left: 50px; width: 600px !important;}
    .cote-droit { top: 0px; left: 1100px; width: 600px !important;}
    .volet { top: 480px; left: -20px; width: 450px !important;}
    .portes { top: 480px; left: 1400px; width: 400px !important;}

    /* Zones cliquables */
    .click-zone {
      position: absolute;
      cursor: pointer;
      /* background: rgba(255, 0, 0, 0.15); /* décommenter pour voir zones */
      border: 2px dashed transparent; /* visible au focus */
      transition: border-color 0.3s ease;
    }
    .click-zone:hover,
    .click-zone:focus {
      border-color: #002c52;
      outline: none;
    }

    /* Menu dynamique */
    #zoneMenu {
      display: none;
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      z-index: 1000;
      width: 280px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 0.9rem;
    }
    #zoneMenu strong {
      display: block;
      margin-bottom: 8px;
      font-size: 1.1rem;
      color: #002c52;
    }
    #zoneMenu label {
      display: block;
      margin-bottom: 4px;
    }
    #zoneMenu select {
      width: 100%;
      margin-bottom: 10px;
      padding: 6px;
      font-size: 1rem;
    }
    #zoneMenu button {
      margin-right: 10px;
      padding: 6px 12px;
      font-size: 1rem;
      cursor: pointer;
      border: none;
      color: white;
      background-color: #002c52;
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }
    #zoneMenu button:hover {
      background-color: #004080;
    }

    /* Liste des retouches */
    #retoucheTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 10px;
    }
    #retoucheTable th, #retoucheTable td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    #retoucheTable th {
      background-color: #002c52;
      color: white;
    }

    /* Boutons sous tableau */
    .btns-table {
      margin: 10px 0 30px;
      text-align: right;
    }
    .btns-table button {
      padding: 8px 16px;
      margin-left: 10px;
      background-color: #002c52;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }
    .btns-table button:hover {
      background-color: #004080;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> 
</head>
<body>
  <div class="header">
    <img src="images/logo.png" alt="Logo" class="logo" />
    Indiquez quelle zone retouchée :
  </div>

  <div class="tabs">
  <button class="tab-button active" onclick="openTab('tab1', event)">Photos</button>
  <button class="tab-button" onclick="openTab('tab2', event)">Liste des retouches</button>
  <button class="tab-button" onclick="openTab('tab3', event); majPareto()">Pareto</button>
</div>


  <div id="tab1" class="tab-content active">
    <div class="vehicle-map-container">

      <!-- Images en arrière-plan -->
      <img src="images/face_avant.png" class="zone face-avant" alt="Face avant" />
      <img src="images/aile_gauche.png" class="zone aile-gauche" alt="Aile gauche" />
      <img src="images/aile_droite.png" class="zone aile-droite" alt="Aile droite" />
      <img src="images/face_gauche.png" class="zone cote-gauche" alt="Côté gauche" />
      <img src="images/face_droite.png" class="zone cote-droit" alt="Côté droit" />
      <img src="images/volet.png" class="zone volet" alt="Volet arrière" />
      <img src="images/portes_battantes.png" class="zone portes" alt="Portes battantes" />

      <!-- FACE AV -->
<div class="click-zone"
     data-zone="Capot / Calandre"
     data-codecls="6HDU3"
     data-defauts='["Jeu"]'
     style="top: 450px; left: 720px; width: 300px; height: 30px;"></div>

<!-- AILE G -->
<div class="click-zone"
     data-zone="Capot / Aile G"
     data-codecls="6JOV3"
     data-defauts='["Jeu","Affleurement"]'
     style="top: 375px; left: 1150px; width: 150px; height: 30px; transform: rotate(-15deg);"></div>

<!-- AILE D -->
<div class="click-zone"
     data-zone="Capot / Aile D"
     data-codecls="6JOV2"
     data-defauts='["Jeu","Affleurement"]'
     style="top: 390px; left: 400px; width: 150px; height: 30px; transform: rotate(15deg);"></div>

<!-- GAUCHE -->
<div class="click-zone"
     data-zone="AileAVG / PAVG"
     data-codecls="6KDK5"
     data-defauts='["Affleurement"]'
     style="top: 110px; left: 160px; width: 20px; height: 120px;"></div>

<div class="click-zone"
     data-zone="PAVG / PLCG"
     data-codecls="6KDK7"
     data-defauts='["Affleurement central","Affleurement partie sup","Affleurement partie inf","Queue de billard","Alignement"]'
     style="top: 50px; left: 305px; width: 20px; height: 180px;"></div>

<div class="click-zone"
     data-zone="PLCG / CCG"
     data-codecls="6LSD4"
     data-defauts='["Affleurement partie sup","Affleurement partie inf"]'
     style="top: 50px; left: 450px; width: 20px; height: 180px;"></div>

<!-- DROIT -->
<div class="click-zone"
     data-zone="AileAVD / PAVD"
     data-codecls="6JZV1"
     data-defauts='["Affleurement"]'
     style="top: 110px; left: 1560px; width: 20px; height: 120px;"></div>

<div class="click-zone"
     data-zone="PAVD / PLCD"
     data-codecls="6JZV7"
     data-defauts='["Affleurement central","Affleurement partie sup","Affleurement partie inf","Queue de billard","Alignement"]'
     style="top: 50px; left: 1425px; width: 20px; height: 180px;"></div>

<div class="click-zone"
     data-zone="PLCD / CCD"
     data-codecls="6LSB4"
     data-defauts='["Affleurement partie sup","Affleurement partie inf"]'
     style="top: 50px; left: 1275px; width: 20px; height: 180px;"></div>

<!-- PORTES BATTANTES -->
<div class="click-zone"
     data-zone="PorteG / Porte D"
     data-codecls="6KLL1"
     data-defauts='["Queue de billard","Affleurement"]'
     style="top: 480px; left: 1600px; width: 20px; height: 280px;"></div>

<div class="click-zone"
     data-zone="Porte Battante G / Parechoc AR"
     data-codecls="6LWJ5"
     data-defauts='["Affleurement"]'
     style="top: 730px; left: 1470px; width: 140px; height: 30px;"></div>

<div class="click-zone"
     data-zone="Porte Battante D / Parechoc AR"
     data-codecls="6LWJ4"
     data-defauts='["Affleurement"]'
     style="top: 730px; left: 1610px; width: 140px; height: 30px;"></div>

<div class="click-zone"
     data-zone="CharnièreG / Porte battanteG"
     data-codecls="6UPK1"
     data-defauts='["Affleurement"]'
     style="top: 490px; left: 1450px; width: 20px; height: 200px;"></div>

<div class="click-zone"
     data-zone="CharnièreD / Porte battanteD"
     data-codecls="6KLV1"
     data-defauts='["Affleurement"]'
     style="top: 490px; left: 1730px; width: 20px; height: 200px;"></div>

<!-- VOLET -->
<div class="click-zone"
     data-zone="Feux ARG / Volet"
     data-codecls="6SGL3"
     data-defauts='["Affleurement"]'
     style="top: 0px; left: 0px; width: 0px; height: 0px;"></div>

<div class="click-zone"
     data-zone="Feux ARD / Volet"
     data-codecls="6SGK3"
     data-defauts='["Affleurement"]'
     style="top: 0px; left: 0px; width: 0px; height: 0px;"></div>

<div class="click-zone"
     data-zone="Volet / Parechoc AR"
     data-codecls="6JPW1"
     data-defauts='["Affleurement gauche","Affleurement central","Affleurement droit"]'
     style="top: 730px; left: 100px; width: 220px; height: 30px;"></div>

<div class="click-zone"
     data-zone="Volet / CCG"
     data-codecls="6JPW5"
     data-defauts='["Affleurement"]'
     style="top: 520px; left: 55px; width: 30px; height: 130px;"></div>

<div class="click-zone"
     data-zone="Volet / CCD"
     data-codecls="6JPW6"
     data-defauts='["Affleurement"]'
     style="top: 520px; left: 330px; width: 30px; height: 130px;"></div>


      <!-- Menu dynamique caché -->
      <div id="zoneMenu" class="zone-select" aria-hidden="true" role="dialog" aria-modal="true">
        <strong id="zoneName"></strong>
        <label for="defautSelect">Nature du défaut :</label>
        <select id="defautSelect"></select>
        <div>
          <button onclick="validerDefaut()">Valider</button>
          <button onclick="fermerMenu()">Annuler</button>
        </div>
      </div>

    </div>
  </div>

  <div id="tab2" class="tab-content">
    <h3>Liste des retouches enregistrées :</h3>
    <table id="retoucheTable" aria-label="Liste des retouches">
      <thead>
        <tr>
          <th>Zone</th>
          <th>Défaut</th>
          <th>Code CLS</th>
          <th>Heure</th>
        </tr>
      </thead>
      <tbody id="retoucheBody"></tbody>
    </table>
    <div class="btns-table">
      <button onclick="supprimerDerniere()">Supprimer dernière retouche</button>
      <button onclick="supprimerToutes()">Supprimer toute la liste</button>
      <button class="btn-imprimer" onclick="window.print()">Imprimer</button>
    </div>
  </div>

  <div id="tab3" class="tab-content">
  <h3>Pareto des défauts enregistrés</h3>
  <canvas id="paretoChart" width="800" height="400" aria-label="Graphique Pareto"></canvas>
  <div class="btns-table">
    <button onclick="window.print()">Imprimer le Pareto</button>
  </div>
</div>


  <script>
    // Gestion onglets
    function openTab(tabId, event) {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Variables pour menu zones
    const zoneMenu = document.getElementById('zoneMenu');
    const zoneNameElem = document.getElementById('zoneName');
    const defautSelect = document.getElementById('defautSelect');
    const retoucheBody = document.getElementById('retoucheBody');
    let selectedZone = null;

    // Ouverture menu au clic sur zone
    document.querySelectorAll('.click-zone').forEach(zone => {
      zone.addEventListener('click', (e) => {
        selectedZone = zone;
        const zoneNom = zone.dataset.zone;
        const codeCLS = zone.dataset.codecls;
        const defauts = JSON.parse(zone.dataset.defauts);

        zoneNameElem.textContent = `${zoneNom} (Code CLS: ${codeCLS})`;

        // Remplir dropdown
        defautSelect.innerHTML = '';
        defauts.forEach(d => {
          const option = document.createElement('option');
          option.value = d;
          option.textContent = d;
          defautSelect.appendChild(option);
        });

        // Afficher menu à la position du clic (relative à la fenêtre)
        const rect = e.target.getBoundingClientRect();
        let top = rect.top + window.scrollY + rect.height -300;
        let left = rect.left + window.scrollX- 200;

        zoneMenu.style.top = top + 'px';
        zoneMenu.style.left = left + 'px';
        zoneMenu.style.display = 'block';
        zoneMenu.setAttribute('aria-hidden', 'false');

        e.stopPropagation(); // éviter propagation au body
      });
    });



    // Fermer menu
    function fermerMenu() {
      zoneMenu.style.display = 'none';
      zoneMenu.setAttribute('aria-hidden', 'true');
      selectedZone = null;
    }

    document.body.addEventListener('click', (e) => {
  // Si le clic n'est pas dans le menu, on ferme
  if (!zoneMenu.contains(e.target)) {
    fermerMenu();
  }
});


// Suppression dernière retouche côté serveur + mise à jour affichage
async function supprimerDerniere() {
  try {
    const response = await fetch('http://localhost:3000/retouches/last', {
      method: 'DELETE'
    });
    if (response.ok) {
      chargerRetouches();
    } else {
      const err = await response.json();
      alert('Erreur: ' + JSON.stringify(err));
    }
  } catch (e) {
    console.error("Erreur fetch supprimerDerniere:", e);
  }
}


// Suppression totale côté serveur + mise à jour affichage
async function supprimerToutes() {
  const response = await fetch('http://localhost:3000/retouches', {
    method: 'DELETE'
  });
  if (response.ok) {
    chargerRetouches();
  } else {
    alert('Erreur lors de la suppression totale');
  }
}


function majPareto() {
  const lignes = retoucheBody.querySelectorAll('tr');
  const comptageZones = {};

  lignes.forEach(ligne => {
    const zone = ligne.children[0].textContent.trim(); // colonne 0 = Zone
    comptageZones[zone] = (comptageZones[zone] || 0) + 1;
  });

  // Tri décroissant pour un vrai Pareto
  const tri = Object.entries(comptageZones).sort((a, b) => b[1] - a[1]);
  const labels = tri.map(([zone]) => zone);
  const valeurs = tri.map(([, count]) => count);

  paretoChart.data.labels = labels;
  const couleurs = valeurs.map(val => {
  if (val > 15) return 'red';
  else if (val > 10) return 'orange';
  else return '#002c52';
});

paretoChart.data.datasets[0].data = valeurs;
paretoChart.data.datasets[0].backgroundColor = couleurs;
paretoChart.update();
}


async function validerDefaut() {
  if (!selectedZone) return;

  const zoneNom = selectedZone.dataset.zone;
  const codeCLS = selectedZone.dataset.codecls;
  const defautChoisi = defautSelect.value;
  const heure = new Date().toLocaleTimeString();

  // Créer la ligne dans le tableau
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${zoneNom}</td>
    <td>${defautChoisi}</td>
    <td>${codeCLS}</td>
    <td>${heure}</td>
  `;
  retoucheBody.appendChild(tr);

  // Cacher le menu
  fermerMenu();

  // Facultatif : envoyer au serveur si back-end
  const retouche = {
    zone: zoneNom,
    defauts: [defautChoisi],
    codecls: codeCLS,
    heure: new Date().toISOString()
  };
  await envoyerRetouche(retouche);
}



  


// Pareto Chart initial
let paretoChart;
document.addEventListener('DOMContentLoaded', () => {
  const ctx = document.getElementById('paretoChart').getContext('2d');
  paretoChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [],
      datasets: [{
        label: 'Nombre de défauts',
        data: [],
        backgroundColor: '#002c52',
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: { precision:0 }
        }
      }
    }
  });
});
// Fonction pour envoyer une retouche au serveur
  async function envoyerRetouche(retouche) {
    const response = await fetch('http://localhost:3000/retouches', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(retouche)
    });
    if (!response.ok) {
      alert('Erreur lors de l’envoi de la retouche');
    }
  }

  // Fonction pour récupérer et afficher la liste des retouches
    // Fonction pour récupérer et afficher la liste des retouches
  async function chargerRetouches() {
    try {
      const response = await fetch('http://localhost:3000/retouches');
      const retouches = await response.json();
      console.log("✅ Données reçues :", retouches);

      const tbody = document.getElementById('retoucheBody');
      // Nettoyer toutes les lignes
      tbody.innerHTML = "";

      // Ajouter lignes retouches
      retouches.forEach(r => {
        const tr = document.createElement('tr');
        tr.classList.add('data-row');
        tr.innerHTML = `
          <td>${r.zone}</td>
          <td>${r.defauts.join(', ')}</td>
          <td>${r.codecls}</td>
          <td>${new Date(r.heure).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error("❌ Erreur dans chargerRetouches :", e);
    }
  }

  // Appel initial au chargement de la page
  chargerRetouches();

  // Exemple: quand utilisateur valide une retouche
  function validerRetouche(zone, defauts, codecls) {
    const retouche = {
      zone,
      defauts,
      codecls,
      heure: new Date().toISOString()
    };
    envoyerRetouche(retouche).then(() => {
      chargerRetouches();
    });
  }

  // Charger la liste au démarrage
  window.onload = () => {
    chargerRetouches();
  };


  </script>
</body>
</html>
